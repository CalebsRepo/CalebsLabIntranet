<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css">
    <link rel="stylesheet" href="../css/holidayCondition.css">
    <link rel="stylesheet" href="../css/menu.css">
    <script src="../js/common.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <title>휴가현황상세</title>
    <script language = "javascript">
    <!-- 페이지 넘어올때 -->
    $(function(){
        ajaxResult = JSON.parse(getStorageItem());
        console.log(ajaxResult)
        for(var i=0; i<ajaxResult.length; i++) {
            var holidayListview = document.getElementById('holidayListview');

            var join_year       = ajaxResult[i].join_year;          //  근무년수
            var join_day        = ajaxResult[i].join_day;           //  근무일수
            var usingHolilday   = ajaxResult[i].use_holiday_cnt     //  사용휴가일수
            var workingYear     = join_year + 1;
            var workingDate     = ""                                // 근무기간( 'x년x개월x일')

            <!-- 근무기간 계산 -->
            if(join_day < 30) {
                day = join_day;
                workingDate = day + '일';
            } else if (join_day < 365) {
                month = Math.floor(join_day/30);
                day = join_day - (month * 30);
                workingDate =  month + '개월 ' + day + '일';
            } else {
                year = Math.floor(join_day/365);
                month = Math.floor((join_day-(year*365))/30);
                day = join_day - (year*365) - (month*30);
                workingDate =  year + '년 ' + month + '개월 ' + day + '일';
            }
            <!-- 사원정보 -->
            $("#holidayListview").append("<li class='ui-corner-all'>"
                                    +"<a href='#' class='list-detail ui-btn ui-btn-icon-right ui-icon-carat-r ui-corner-all'>"
                                    +"<input class='detailID' name='detailID' type='hidden' value='" + ajaxResult[i].id + "'> "
                                    +"<div class='plan plan-name'> 이름 : " + ajaxResult[i].name + "</div>"
                                    +"<div class='plan plan-name'> 직급 : " + ajaxResult[i].grade + "</div>"
                                    +"<div class='plan plan-name'> 입사일 : " + ajaxResult[i].join_ymd + "</div>"
                                    +"<div class='plan plan-name'> 근속일자 : " + workingDate + "</div>"
                                    + "</a>"
                                + "</li>");
        };

        <!-- 셀렉트 박스 옵션값 -->
        if (join_day > 365 ) {
           for ( var y =0;  y < workingYear; y++) {
               var optionYear = workingYear - y ;
               $("#workYear").append("<option value='"+y+"'> "+optionYear +" 년차</option>" );
           }
        } else {
           $("#workYear").append("<option value='0'> 1년차</option>" );
        }

        <!-- 셀렉트 초기 세팅 -->
        $(".ui-select .ui-btn > span:not(.ui-li-count)").text(join_year +1 +" 년차");
        $("#default").text(join_year +1 +" 년차")

        var selectId    = $(".detailID").val();
        var selectYear  = - $("#workYear option:selected").val();
        var compareYear = selectYear -1;
        var params = {
            selectId : selectId,
            selectYear : selectYear,
            compareYear : compareYear
        }
        navigate( params,"getHolidayConditionDetail.json", sucessFncMyHoliday );
        navigate( params,"getHolidayConditionDetailCompare.json", sucessFncMyHoliday2 );
    });

    <!-- 셀렉트박스 값에 따른 휴가사용내역 -->
    $(function(){
        $('#workYear').change(function(e){

            var selectId = $(".detailID").val();
            var selectYear = -$("#workYear option:selected").val();
            var compareYear = selectYear -1;
            var params = {
                selectId : selectId,
                selectYear : selectYear,
                compareYear : compareYear
            }
            navigate( params,"getHolidayConditionDetail.json", sucessFncMyHoliday);
            navigate( params,"getHolidayConditionDetailCompare.json", sucessFncMyHoliday2);
        });
    });

    <!--휴가사용내역 ajax통신 성공-->
    function sucessFncMyHoliday(result) {

        $("#my-tbody").children().remove();
        $("#info-banner").children().remove();

        ajaxResult=result;
        var usingHolilday = 0;

        for(var i=0; i<ajaxResult.length; i++) {
            var holidayCnt = 15;                                //  기본휴가일수 used
            var wd_80 = 292;                                    //  입사 후 1년 80% 근무일수  used
            var join_year = ajaxResult[i].join_year;           //  근무년수  used
            var join_mon = ajaxResult[i].join_mon;             //  근무월수
            var join_day = ajaxResult[i].join_day;             //  근무일수  used
            usingHolilday += ajaxResult[i].apply_count      //  사용휴가일수
            var workingYear = join_year+1 - parseInt($('#workYear option:selected').val());

            if(workingYear == 3) {
                holidayCnt = holidayCnt + 1;
            }else if(workingYear > 3) {
                holidayCal = holidayCnt + 1 + Math.floor(( workingYear - 3)/2);
                holidayCnt = (holidayCal > 25) ? 25 : holidayCal;
            }else if(join_day < wd_80) {
                holidayCnt = join_mon * 1;
            };
            var holidayResult = holidayCnt - usingHolilday;
            var holidayInfo = document.getElementById("info-banner");

            holidayInfo.innerHTML = "<div><h3 style='margin: 0;'>"+ $('#workYear option:selected').text() +"</h3></div>"
                                    +"<div class='plan plan-date'> 연차 발생기간 : " + ajaxResult[i].hs_ymd +" ~ " + ajaxResult[i].he_ymd  + "</div>"
                                    +"<div class='plan-teamCnt'> 연차 발생 일수 : " + holidayCnt +" 일 </div>"
                                    +"<div class='plan-teamCnt'> 연차 사용 일수 : " + usingHolilday +" 일 </div>"
                                    +"<div class='plan-state'> 남은 연차일수 : " + holidayResult + " 일</div>"


             var my_tbody = document.getElementById('my-tbody');
            var row = my_tbody.insertRow( my_tbody.rows.length ); // 하단에 추가
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var num = i + 1

            cell1.innerHTML = num;
            cell2.innerHTML = ajaxResult[i].apply_seq
            cell3.innerHTML = ajaxResult[i].h_type +"/"+ ajaxResult[i].h_flag
            cell4.innerHTML = ajaxResult[i].start_ymd +"<br/> ~ <br/>" + ajaxResult[i].end_ymd
       }
    }

    <!--휴가사용 전년도내역 ajax통신 성공-->
    function sucessFncMyHoliday2(result) {

        $("#my-tbody2").children().remove();
        $("#info-banner2").children().remove();

       console.log("sucessFncMyHoliday>2222222222>>>>>" + JSON.stringify(result));
       ajaxResult=JSON.stringify(result);
       ajaxResult2=JSON.parse(ajaxResult);
       console.log("sucessFncMyHoliday>22222222222>>>>" + ajaxResult2);

        var usingHolilday = 0;

       for(var i=0; i<ajaxResult2.length; i++){
            var holidayCnt = 15;                                //  기본휴가일수
            var wd_80 = 292;                                    //  입사 후 1년 80% 근무일수
            var join_year = ajaxResult2[i].join_year;           //  근무년수
            var join_mon = ajaxResult2[i].join_mon;             //  근무월수
            var join_day = ajaxResult2[i].join_day;             //  근무일수
            usingHolilday += ajaxResult2[i].apply_count      //  사용휴가일수
            var c_join_year = join_year - parseInt($('#workYear option:selected').val());

            if(c_join_year == 3) {
                holidayCnt = holidayCnt + 1;                                        // 입사후 3년 근무 시 15 + 1 일 휴가
            }else if(c_join_year > 3) {
                holidayCal = holidayCnt + 1 + Math.floor((c_join_year - 3)/2);        // 입사 3년 후 2년마다 +1:  15+1 + (2년*1)일 휴가 max : 25
                holidayCnt = (holidayCal > 25) ? 25 : holidayCal;
            }else if(join_day < wd_80) {
                holidayCnt = join_mon * 1;                                          // 근속년수 80% 미만인 사람은 1개월 개근시 1일의 휴가
            };
            var holidayResult = holidayCnt - usingHolilday;
            var holidayInfo2 = document.getElementById("info-banner2");

            holidayInfo2.innerHTML ="<div><h3 style='margin: 0;'>"+ c_join_year +" 년차</h3></div>"
                                    +"<div class='plan plan-date'> 연차 발생기간 : " + ajaxResult2[i].chs_ymd +" ~ " + ajaxResult2[i].che_ymd  + "</div>"
                                    +"<div class='plan-teamCnt'> 연차 발생 일수 : " + holidayCnt +" 일 </div>"
                                    +"<div class='plan-teamCnt'> 연차 사용 일수 : " + usingHolilday +" 일 </div>"
                                    +"<div class='plan-state'> 남은 연차일수 : " + holidayResult + " 일</div>"



            var my_tbody2 = document.getElementById('my-tbody2');
            var row = my_tbody2.insertRow( my_tbody2.rows.length );
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var num = i + 1

            cell1.innerHTML = num;
            cell2.innerHTML = ajaxResult2[i].apply_seq
            cell3.innerHTML = ajaxResult2[i].h_type +"/"+ ajaxResult2[i].h_flag
            cell4.innerHTML = ajaxResult2[i].start_ymd +"<br/> ~ <br/>" + ajaxResult2[i].end_ymd
       }
    }




    </script>
</head>
<body>
<section id="pageHolidayConditionDetail" data-role="page">

    <!-- header -->
    <header data-role="header">
        <h1>CalebsLab</h1>
        <a class="ui-btn ui-corner-all ui-btn-inline ui-mini footer-button-left ui-btn-icon-left ui-icon-carat-l" href="javascript:history.back()">back</a>
        <a href="#menuPanel" class="ui-btn-right" data-icon="bars">menu</a>
    </header>

    <div data-role="panel" class="menuPanel" id="menuPanel"  data-position="right"  data-display="overlay" data-theme="a">
        <img src="../css/images/calebslab_CI_1_upper-300x108.png" alt="CalebsLab">
        <ul data-role="listview">
            <p>내정보</p>
            <li><a href="#">마이페이지</a></li>
            <p>프로젝트</p>
            <li><a href="#">프로젝트</a></li>
            <li><a href="#">프로젝트일정 목록</a></li>
            <p>휴가</p>
            <li><a href="#">휴가신청</a></li>
            <li><a href="#">휴가신청내역</a></li>
            <li><a href="#">휴가캘린더</a></li>
            <p>게시판</p>
            <li><a href="#">FAQ</a></li>
            <p>관리</p>
            <li><a href="#">사원등록</a></li>
            <li><a href="#">사원목록</a></li>
            <li><a onclick="movePage('holidayCondition.html')">휴가현황</a></li>
        </ul>
    </div>

    <!-- content -->
    <div data-role="content" class="main-warp">
        <div class="gird-pt">
            <h2>휴가현황 상세</h2>
            <ul id="holidayListview" data-role="listview" data-inset="true" class="ui-listview ui-listview-inset ui-corner-all ui-shadow"data-theme="a">
            </ul>
            <div class="ui-field-contain">
                <label id="workYearLabel"for="workYear">연차검색</label>
                <select name= "workYear" id='workYear' class='ui-corner-all'>
                    <option id="default" value="0" selected disabled hidden></option>
                </select>
            </div>
            <div id="info-banner"></div>
        </div>

        <table id="selectYearList">
            <thead>
            <th width="10%">번호</th>
            <th width="30%">신청번호</th>
            <th width="30%">구분/종류</th>
            <th width="30%">휴가기간</th>
            </thead>
            <tbody id="my-tbody" style="text-align:center;"></tbody>
        </table>


        <div class="divider" style="text-align: center;">
            <span style="width: 55%; height: 2px; margin: 1em 0; background-color: #d7d7d7; display: inline-block;"></span>
        </div>


        <div id="info-banner2">

        </div>
        <table id="compareYearList">
            <thead>
            <th width="10%">번호</th>
            <th width="30%">신청번호</th>
            <th width="30%">구분/종류</th>
            <th width="30%">휴가기간</th>
            </thead>
            <tbody id="my-tbody2" style="text-align:center;"></tbody>
        </table>
    </div>


    <!-- footer -->
    <div style="overflow: hidden;" data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a onclick="movePage('main.html')" data-icon="home">홈</a></li>
                <li><a href="#" data-icon="shop">프로젝트</a></li>
                <li><a href="#" data-icon="calendar">휴가신청</a></li>
                <li><a href="#" data-icon="power">로그아웃</a></li>
            </ul>
        </div>
    </div>
</section>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css">
    <script src="../js/common.js"></script>
    <script src="../js/login.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script language="JavaScript">

       var newToken = "";

        $(document).ready(function(){

            var chkSaveId = localStorage.getItem("chkSave");

            if(chkSaveId == "Y"){

                $("input:checkbox[id='saveIdIpt']").prop("checked", true);
                var savedId = localStorage.getItem("savedId");

                $('#id').val(savedId);
            }

            window.android.pushToken(); // PUSH 토큰 가져오기

        });

        function getToken(token) {
            newToken = token;
        }


        function login(){

            var id = $('#id').val();
            var pwd = $('#pwd').val();

            if(id == null || id ==''){
                alert("아이디를 입력해주세요");
                return false;
            }

            if(pwd == null || pwd ==''){
                alert("비밀번호를 입력해주세요");
                return false;
            }

            var param = {"id" : id, "pwd" : pwd};
            //아이디 저장 체크 여부
            var saveChk = $("input:checkbox[id='saveIdIpt']").is(':checked');
            var result = callLogin(id,pwd);

            if(result != ""){

                if(saveChk == true){
                    localStorage.setItem("chkSave","Y");
                    localStorage.setItem("savedId",id);
                }else{
                    localStorage.setItem("chkSave","N");
                    localStorage.removeItem("savedId");
                }

               sessionStorage.setItem("userData",result);

               /* push 토큰 비교 및 업데이트 */
               var value        = JSON.parse(sessionStorage.getItem("userData"));
               var sessionToken = "";

               sessionToken = value.push_token;

               console.log("sessionToken : " + sessionToken);

               if((sessionToken != newToken) || sessionToken == "" || sessionToken == null) {

                    push_token = newToken;

                    var params = {
                        id         : id,
                        push_token : push_token
                    };
                    navigate(params, "tokenUpdate.json", tokenUpdateSuccess);
                }else {
                    movePage("index.html");
                }
            }else{
                alert("입력한 회원정보가 일치하지 않습니다");
            }

            /* push토큰 업데이트 완료 후*/
            function tokenUpdateSuccess() {
                movePage("index.html");
            }


        }

    </script>

    <style>
        #loginDiv {background-color:white; padding:10% 10% 0 10%; height: 100%;}
        #logoImg {max-width:100%; max-height:100%; margin:auto; display:block; margin-bottom : 20%}
        #loginBtn {margin-top : 20px;}
        #saveIdIpt {left:0em; position:relative; margin-top:0px; top:5px}
        .ui-checkbox {display:inline}
    </style>
</head>

<body bgcolor="#E6E6FA">

<div id="loginDiv" class="container">

    <div id="imgDiv">
        <img src="../css/images/calebslab_CI_1_upper-300x108.png" id="logoImg">
        <label for="id">아이디</label>
        <input type="text" name="id" id="id" value="">
        <label for="pwd">비밀번호</label>
        <input type="password" name="pwd" id="pwd" value="">
    </div>
    <div id="loginBtn" onclick="event.cancelBubble = true;">
        <button class="ui-btn ui-corner-all" onclick="login();">확인</button>
    </div>
    <div style="display:inline-block; width:49%">
        <input type="checkbox" id="saveIdIpt">
        <a id="saveId">ID 저장</a>
    </div>
    <div style="display:inline-block; text-align:right;width:49%">
        <a id="findId" onclick="movePage('findId.html')">ID</a> /
        <a id="findPw">PW</a> 찾기
    </div>
</div>

</body>
</html>
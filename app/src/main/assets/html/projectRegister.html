<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css">
    <link rel="stylesheet" href="../css/project_info.css">
    <link rel="stylesheet" href="../css/menu.css">
    <script src="../js/common.js"></script>
    <script src="../js/login.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="../js/jquery.mobile-1.4.5.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!--DatePicker--><script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <!--DatePicker--><script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="../js/datepicker.js"></script>
    <script type="text/javascript">
        var loginUser = JSON.parse(getUserData());
        var loginUserAdmFlag = loginUser.adm_flag;

        $(document).ready(function(){
            // 프로젝트 종료일이 시작일 이후로만 선택되도록 datepicker를 설정
            $("#projectStartDt").datepicker({
            onSelect: function(selected) {
                $("#projectEndDt").datepicker("option","minDate", selected)
            }
            });
            $("#projectEndDt").datepicker({
            onSelect: function(selected) {
                $("#projectStartDt").datepicker("option","maxDate", selected)
            }
            });

            if(loginUserAdmFlag == "A" || loginUserAdmFlag == "G"){
                $(".admMenu").show();
            }

            <!--발주회사정보를 db에서 가져와 화면에 뿌려줌-->
            navigate("", "getCompany.json", getCompanyInfoSuccess);
        });

        <!--발주회사 정보 select 성공-->
        function getCompanyInfoSuccess(result) {
            var companyInfoResult="";
            var parseCompanyResult="";
            //console.log("============================================");
            companyInfoResult=JSON.stringify(result);
            parseCompanyResult=JSON.parse(companyInfoResult);
            //console.log("getCompanyInfoSuccess>>>>>" + companyInfoResult);
            //console.log("============================================");

            <!--ID로 select태그를 찾아 변수에 Mapping-->
            var selbox = document.getElementById('projectComp');

            for(var i=0; i<parseCompanyResult.length; i++) {
                //console.log(parseCompanyResult[i].comp_id);
                //console.log(parseCompanyResult[i].comp_name);

                <!--멤버 id와 이름을 가져와 option에 value, text와 Mapping-->
                var op = new Option();

                op.value = parseCompanyResult[i].comp_id;
                op.text = parseCompanyResult[i].comp_name;

                <!--selectBox에 option 추가-->
                selbox.options.add(op);
            }
        }
        var ind=0;

        <!--참여인원 삭제버튼 클릭 이벤트-->
        function btnDel() {
            console.log("btnDel 함수 진입");
            var checkbox = document.getElementsByName("listChb"); // 체크박스 Element를 배열로 Get
            var listviewArea = document.getElementById("listviewArea");
            var checkboxLength = checkbox.length;
            console.log("checkboxLength = " + checkboxLength);
            for(var i=0; i<checkbox.length; i++) {
                console.log("i = " + i);
                if(checkbox[i].checked == true) {
                    var checkboxID = checkbox[i].id; // ID 추출
                    console.log(checkboxID + " is checked");
                    var index = checkboxID.replace(/[^0-9]/g,''); // list의 index를 찾기 위해 id값에서 숫자만 추출
                    console.log("index = " + index);
                    var memberAreaID = "memberArea" + index; // listForm의 ID를 index로 Mapping
                    console.log("memberAreaID = " + memberAreaID);
                    var removeArea = document.getElementById(memberAreaID); // Mapping한 ID로 Remove할 division을 Get
                    listviewArea.removeChild(removeArea); // Division 삭제
                    i--;
                } else {
                    var checkboxID = checkbox[i].id;
                    console.log(checkboxID + "is not checked");
                }
            }
        }
        <!--참여인원 추가버튼 클릭 이벤트-->
        function btnAdd() {
            var iHTML = "";
            ind++;

            iHTML += '<div id="memberArea'+ind+'" class="member-area ui-field-contain">';
            iHTML += '    <label style="width:22px"><div class="ui-checkbox"><input type="checkbox" id="listChb'+ind+'" name="listChb" style="position: unset; left: unset;"></div></label>';
            iHTML += '    <ul data-role="listview" data-inset="true" class="list-area  ui-listview ui-listview-inset ui-corner-all ui-shadow">';
            iHTML += '        <li class="member-name ui-field-contain ui-li-static ui-body-inherit ui-first-child">';
            iHTML += '            <label>참여인원</label>';
            iHTML += '            <div class="member">';
            iHTML += '                <div class="ui-select"><div id="memberSel'+ind+'-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span class="memberSel">선택하세요</span><select id="memberSel'+ind+'" name="memberSel" class="memberSel" onchange="memberSelect('+ind+')" style="z-index: 0;">';
            iHTML += '                    <option value="">선택하세요</option>';
            iHTML += '                </select></div></div>&nbsp;';
            iHTML += '                <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" id="memberName'+ind+'" name="memberName" readonly></div>';
            iHTML += '            </div>';
            iHTML += '        </li>';
            iHTML += '        <li class="memeber-date ui-field-contain ui-li-static ui-body-inherit">';
            iHTML += '            <label>참여기간</label>';
            iHTML += '            <div class="picker">';
            iHTML += '                <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" id="putDt'+ind+'" name="putDt" class="datepicker" readonly></div> ~';
            iHTML += '                <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" id="withdrawDt'+ind+'" name="withdrawDt" class="datepicker" readonly></div>';
            iHTML += '            </div>';
            iHTML += '        </li>';
            iHTML += '        <li class="skill ui-field-contain ui-li-static ui-body-inherit">';
            iHTML += '            <label>사용기술</label>';
            iHTML += '            <textarea cols="40" rows="8" id="skillTarea'+ind+'" name="skill" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="height: 52px;"></textarea>';
            iHTML += '        </li>';
            iHTML += '        <li class="grade ui-field-contain ui-li-static ui-body-inherit">';
            iHTML += '            <label>기술등급</label>';
            iHTML += '            <div class="ui-select"><div id="gradeSel'+ind+'-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span>선택하세요</span><select id="gradeSel'+ind+'" name="gradeSel" onchange="gradeSelect('+ind+')" style="z-index: 0;">';
            iHTML += '                <option value="">선택하세요</option>';
            iHTML += '                <option value="특급">특급</option>';
            iHTML += '                <option value="고급">고급</option>';
            iHTML += '                <option value="중급">중급</option>';
            iHTML += '                <option value="초급">초급</option>';
            iHTML += '            </select></div></div>';
            iHTML += '        </li>';
            iHTML += '        <li class="roll ui-field-contain ui-li-static ui-body-inherit ui-last-child">';
            iHTML += '            <label>참여형태</label>';
            iHTML += '            <div class="rollDiv">';
            iHTML += '                <div class="ui-select"><div id="rollSel'+ind+'-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span>선택하세요</span><select id="rollSel'+ind+'" name="rollSel" onchange="rollSelect('+ind+')" style="z-index: 0;">';
            iHTML += '                    <option value="">선택하세요</option>';
            iHTML += '                    <option value="PM">PM</option>';
            iHTML += '                    <option value="PL">PL</option>';
            iHTML += '                    <option value="참여자">참여자</option>';
            iHTML += '                    <option value="직접입력">직접입력</option>';
            iHTML += '                </select></div></div>';
            iHTML += '                &nbsp;';
            iHTML += '                <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="text" id="rollTxt'+ind+'" name="memberRoll" readonly></div>';
            iHTML += '            </div>';
            iHTML += '        </li>';
            iHTML += '    </ul>';
            iHTML += '</div>';

            $("#listviewArea").append(iHTML);
            navigate("", "getFullemployee.json", getEmployeeInfoSuccess);
            $("#putDt"+ind).datepicker({
                numberOfMonths: 1,
                onSelect: function(selected) {
                    $("#withdrawDt"+ind).datepicker("option","minDate", selected)
                }
            });

            $("#withdrawDt"+ind).datepicker({
                numberOfMonths: 1,
                onSelect: function(selected) {
                    $("#putDt"+ind).datepicker("option","maxDate", selected)
                }
            });
        }
         <!--직원정보select 성공-->
        function getEmployeeInfoSuccess(result) {
            var employeeInfoResult="";
            var parseEmployeeResult="";
            //console.log("============================================");
            employeeInfoResult=JSON.stringify(result);
            parseEmployeeResult=JSON.parse(employeeInfoResult);
            //console.log("getEmployeeInfoSuccess>>>>>" + employeeInfoResult);
            //console.log("============================================");

            <!--name으로 select태그를 찾아 변수에 Mapping-->
            var selID = "memberSel" + ind;
            var selbox = document.getElementById(selID);

            for(var i=0; i<parseEmployeeResult.length; i++) {
                //console.log(parseEmployeeResult[i].ID);
                //console.log(parseEmployeeResult[i].NAME);

                <!--멤버 id와 이름을 가져와 option에 value, text와 Mapping-->
                var op = new Option();

                op.value = parseEmployeeResult[i].ID;
                op.text = parseEmployeeResult[i].NAME;

                <!--selectBox에 option 추가-->
                selbox.options.add(op);
            }
            <!--직접입력 option 추가-->
            var op = new Option();
            op.value = "write";
            op.text = "직접입력";

            selbox.options.add(op);
        }

        <!--memberSel select-->
        function memberSelect(index) {
            var selID = 'memberSel' + index;
            var inputID = 'memberName' + index;
            changeSelect(selID, inputID);
        }
        <!--rollSel select-->
        function rollSelect(index) {
            var selID = 'rollSel' + index;
            var inputID = 'rollTxt' + index;
            changeSelect(selID, inputID);
        }
        <!--gradeSel select-->
        function gradeSelect(index) {
            var selID = 'gradeSel' + index;
            changeSelect(selID);
        }
        <!--selectBox 선택 이벤트-->
        function changeSelect(selID, inputID) {
            console.log("selID>>>>>" + selID);
            <!--이벤트가 발생한 selBox 찾기-->
            var memSelect = document.getElementById(selID);

            <!--select element에서 선택된 option의 value가 저장된다.-->
            var selectValue = memSelect.options[memSelect.selectedIndex].value;
            <!--select element에서 선택된 option의 text가 저장된다.-->
            var selectText = memSelect.options[memSelect.selectedIndex].text;
            console.log("selectText>>>>" + selectText);

             $("#"+selID+"-button > span").text(selectText); // 선택된 값을 selectBox Span에 출력

            if(inputID != null) {
                console.log("inputID>>>>>" + inputID);
                <!--선택한 값을 띄울 input-->
                var viewInput = document.getElementById(inputID);
                 if(selectText == '직접입력') {
                    viewInput.readOnly = false;
                    viewInput.value = "";
                 } else {
                    viewInput.value = selectText;
                 }
            }
        }

        function projectRegist() {
            var projectInfoJSON = new Object();
            projectInfoJSON.loginID = loginUser.id;
            // 프로젝트 정보 관련 Validation Check
            // 정규식 정리
            var patternNum = /^[0-9]+$/; // 숫자만 체크
            var patternSpecial = /^[`~!@#$%^&*|\\\'\";:\/?]+$/; // 특수문자만 체크

            // 프로젝트명
            var projectName = document.getElementById('projectName').value;
            if(projectName == "") { // 프로젝트명을 입력하지 않은 경우
                alert("프로젝트명을 입력해주세요");
                return false;
            }
            if(patternNum.test(projectName) || patternSpecial.test(projectName)) { // 프로젝트명이 숫자나 특수문자만으로 구성되어 있는 경우
                alert("프로젝트명을 확인해주세요");
                return false;
            }

            // 발주회사
            var projectComp = document.getElementById('projectComp').value;
            if(projectComp == "") { // 발주회사를 선택하지 않은 경우
                alert("발주회사를 선택해주세요");
                return false;
            }

            // 프로젝트 시작 종료일
            var projectStartDt = document.getElementById('projectStartDt').value;
            var projectEndDt = document.getElementById('projectEndDt').value;
            if(projectStartDt == "" || projectEndDt == "") {
                alert("프로젝트 시작/종료일을 입력해주세요");
                return false;
            }

            // 프로젝트 설명
            var projectExplain = document.getElementById('projectExplain').value;
            if(projectExplain == "") {
                alert("프로젝트 설명을 입력해주세요.");
                return false;
            }

            // 프로젝트 정보 make
            projectInfoJSON.name = projectName;
            projectInfoJSON.company = projectComp;
            projectInfoJSON.code = makeProjectCode(projectComp);
            projectInfoJSON.startDt = projectStartDt;
            projectInfoJSON.endDt = projectEndDt;
            projectInfoJSON.explain = projectExplain;


            // 멤버 투입정보 get
            var memerInfoArray = new Array();
            var memberInfoName = document.getElementsByName('memberName');
            var memberInfoPutDt = document.getElementsByName('putDt');
            var memberInfoWithdrawDt = document.getElementsByName('withdrawDt');
            var memberInfoSkill = document.getElementsByName('skill');
            var memberInfoGrade = document.getElementsByName('gradeSel');
            var memberInfoRoll = document.getElementsByName('memberRoll');
            projectInfoJSON.listIndex = memberInfoName.length;

            // 멤버 입력값이 있을때만 멤버정보 추가
            if(memberInfoName.length > 0) {
                for(var index = 0; index < memberInfoName.length; index++) {
                    // 멤버 정보 관련 Validation Check
                    // 이름
                    if(memberInfoName[index].value == "") {
                        alert("인원 이름을 선택/입력해주세요."); // 필수값 check
                        return false;
                    }
                    // 이름 중복선택 check(이름과 프로젝트 코드가 테이블의 pk역할을 하므로 1개의 프로젝트에 참여인원의 이름이 중복되어서는 안된다.
                    for(var diffIndex = index + 1;diffIndex < memberInfoName.length; diffIndex++) { // 현재 인덱스로부터 마지막까지 반복문을 돌면서
                        if(memberInfoName[index].value == memberInfoName[diffIndex].value) { // 이름이 같으면 return false
                            alert("참여인원은 중복될 수 없습니다.");
                            return false;
                        }
                    }
                    // 참여기간
                    if(memberInfoPutDt[index].value == "" || memberInfoWithdrawDt[index].value == "") {
                        alert("참여기간을 입력해주세요."); // 필수값 check
                        return false;
                    }
                    // 프로젝트 기간과 참여기간의 비교
                    if(diffDate(projectStartDt, memberInfoPutDt[index].value, "start") == false) { // 프로젝트 시작일이 투입일보다 큰 경우
                        alert("투입일은 프로젝트 시작일보다 작을 수 없습니다.");
                        return false;
                    }
                    if(diffDate(projectStartDt, memberInfoPutDt[index].value, "end") == false) { // 프로젝트 종료일이 철수일보다 작은 경우
                        alert("철수일은 프로젝트 시작일보다 클 수 없습니다.");
                        return false;
                    }

                    // 사용기술
                    if(memberInfoSkill[index].value == "") {
                        alert("사용기술을 입력해주세요."); // 필수값 check
                        return false;
                    }

                    // 기술등급
                    if(memberInfoGrade[index].value == "") {
                        alert("기술등급을 선택해주세요."); // 필수값 check
                        return false;
                    }

                    // 참여형태
                    if(memberInfoRoll[index].value == "") {
                        alert("참여형태를 선택해주세요."); // 필수값 check
                        return false;
                    }
                    var memberInfoJSON = new Object();
                    memberInfoJSON.name = memberInfoName[index].value;
                    memberInfoJSON.putDt = memberInfoPutDt[index].value;
                    memberInfoJSON.withdrawDt = memberInfoWithdrawDt[index].value;
                    memberInfoJSON.skill = memberInfoSkill[index].value;
                    memberInfoJSON.grade = memberInfoGrade[index].value;
                    memberInfoJSON.roll = memberInfoRoll[index].value;
                    memerInfoArray.push(memberInfoJSON);
                }
            projectInfoJSON.memberList = memerInfoArray;
            }

            console.log("projectInfoJSON>>>>>" + JSON.stringify(projectInfoJSON));
            console.log("memerInfoArray>>>>>" + JSON.stringify(memerInfoArray));

            navigate(projectInfoJSON, "projectRegist.json", projectRegistSuccess);

        }

        function projectRegistSuccess(result) {
            console.log("성공");
            alert("등록되었습니다.");
            movePage('projectList.html');
        }

        function makeProjectCode(company) {
            // 현재날짜 구하기
            var date = new Date();
            var year = date.getFullYear();
            var month = new String(date.getMonth()+1);
            var day = new String(date.getDate());
            var code = "";

            // 한자리수일 경우 0을 채워준다.
            if(month.length == 1){
              month = "0" + month;
            }
            if(day.length == 1){
              day = "0" + day;
            }

             code = company+ "_" + year  + "_" + month + "_" + day; // 회사코드 뒤에 현재날짜를 append
             return code;
        }

        function diffDate(projectDate, memberDate, trigger) {
            var splitDate1 = projectDate.split('/');
            var splitDate2 = memberDate.split('/');
            var resultData = "";
            var da1 = new Date(splitDate1[0], splitDate1[1], splitDate1[2]);
            var da2 = new Date(splitDate2[0], splitDate2[1], splitDate2[2]);
            var dif = da2 - da1;
            var cDay = 24 * 60 * 60 * 1000;// 시 * 분 * 초 * 밀리세컨
            if(trigger == "start") {
                if(parseInt(dif/cDay) >= 0) {
                    resultData = true;
                } else {
                    resultData = false;
                }
            } else if(trigger == "end") {
                if(parseInt(dif/cDay) <= 0) {
                    resultData = true;
                } else {
                    resultData = false;
                }
            }
        }
    </script>
</head>

<body>
<section id="page1" data-role="page">
    <!-- header -->
    <header data-role="header">
        <h1>프로젝트 등록</h1>
        <a href="#menuPanel" class="ui-btn-right" data-icon="bars">menu</a>
    </header>

    <div data-role="panel" class="menuPanel"id="menuPanel" data-position="right"  data-display="overlay" data-theme="a">
        <img src="../css/images/calebslab_CI_1_upper-300x108.png" alt="CalebsLab">
        <ul id="menuPanelList"data-role="listview">
            <p>내정보</p>
            <li><a onclick= "movePage('employeeDetail.html')" >마이페이지</a></li>
            <p>프로젝트</p>
            <li><a onclick= "movePage('projectList.html')" >프로젝트</a></li>
            <li><a onclick= "movePage('planList.html')" >프로젝트일정 목록</a></li>
            <p>휴가</p>
            <li><a onclick= "movePage('employeeDetail.html')" >휴가신청</a></li>
            <li><a onclick= "movePage('holidayList.html')" >휴가신청내역</a></li>
            <li><a onclick= "movePage('calendar.html')" >휴가캘린더</a></li>
            <p>게시판</p>
            <li><a onclick= "movePage('qnaList.html')" >FAQ</a></li>
            <p class="admMenu">관리</p>
            <li class="admMenu"><a onclick= "movePage('employeeDetail.html')" >사원등록</a></li>
            <li class="admMenu"><a onclick= "movePage('employeeInfo.html')" >사원목록</a></li>
            <li class="admMenu"><a onclick= "movePage('holidayCondition.html')">휴가현황</a></li>
        </ul>
    </div>
    <!-- //container -->
    <div data-role="content" class="regist-project">
        <!--프로젝트 info division-->
        <div class="pjt-info">
            <!--제목-->
            <div class="title_area">
                <h3>• 프로젝트 기본정보 </h3>
            </div>

            <!--프로젝트정보-->
            <div class="gird-pt project-form">
                <form>
                    <div class="ui-field-contain">
                        <label for="projectName">프로젝트명</label>
                        <input type="text" id="projectName">
                    </div>
                    <div class="ui-field-contain">
                        <label for="projectComp">발주회사</label>
                        <select id="projectComp">
                            <option value="" selected="selected" style="z-index: 0;">선택하세요</option>
                        </select>
                    </div>
                    <div class="ui-field-contain">
                        <label for="datepicker">프로젝트 기간</label>
                        <div id="datepicker" class="picker">
                            <input type="text" id="projectStartDt" readonly> ~
                            <input type="text" id="projectEndDt"  readonly>
                        </div>
                    </div>
                    <div class="ui-field-contain">
                        <label for="projectExplain">설명</label>
                        <textarea cols="40" rows="8" id="projectExplain"></textarea>
                    </div>
                </form>
            </div>
        </div>

        <!--참여인원 info division-->
        <div class="member_info">
            <!--제목, 삭제, 추가 버튼-->
            <div class="title-area">
                <div class="gird-pt select-area">
                    <div class="grid-cd-1">
                        <h3>• 참여인원 </h3>
                    </div>
                    <div class="grid-cd-2">
                        <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-b" onclick="btnDel()">삭제</button>
                        <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-b" onclick="btnAdd()">추가</button>
                    </div>
                </div>
            </div>
            <!--인원등록 ListView-->
            <div class="listview-area" id="listviewArea">
            </div>
        </div>

        <!--버튼 Area-->
        <div class="btn_area">
            <div class="grid-pt">
                <div class="grid-cd-1"><button class="ui-btn ui-shadow ui-corner-all" onclick="movePage('projectList.html')">취소</button></div>
                <div class="grid-cd-2"><button class="ui-btn ui-shadow ui-corner-all ui-btn-b" onclick="projectRegist()">등록</button></div>
            </div>
        </div>
    </div>
    <!-- //container -->
    <!-- footer -->
    <div class="footer" data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a onclick="movePage('main.html')" data-icon="home">홈</a></li>
                <li><a onclick="movePage('projectList.html')" data-icon="shop">프로젝트</a></li>
                <li><a href="#" data-icon="calendar">휴가신청</a></li>
                <li><a href="#" data-icon="power" onclick="javascript:callLogout()";>로그아웃</a></li>
            </ul>
        </div>
    </div>
</section>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <title></title>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="../js/common.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <script type="text/javascript">

		var numCnt = 1;
		var userInfo = JSON.parse(getUserData());

		$(document).ready(function(){

			$('#btMore').hide();

            var test = getUserData();
            console.log("test : " + test);
			setDateSelct();
			totalPageCnt();
			showHolidayList();

			// 조회 버튼
			$("#btResult").click(function(){
				// 넘버링 초기화
				$("#pageNum").val("1");
				$("#temp").val($("#approvalSel option:selected").val());
				numCnt = 1;

				totalPageCnt();
				showHolidayList();
			});// end of $("#btResult").click()---------

			// 더보기 버튼
			$("#btMore").click(function(){
				moreList();
			});// end of $("#btMore").click()----------

		});// end of $(document).ready()--------------------------------------------



		// 휴가리스트를 보여주는 함수
		function showHolidayList(){

			var form_data = {
			                  pageNum  : $("#pageNum").val(),
							  checkVal : $("#approvalSel option:selected").val(),
							  date     : $("#dateSel option:selected").val(),
							  id       : userInfo.id,
							  admflag  : userInfo.adm_flag
							 };

            navigate(form_data, "holidayList.json", successHolidayList);

		}// end of showHolidayList()------------------------------------

		// 더보기 함수
		function moreList() {

			var form_data = {
			                   pageNum  : $("#pageNum").val(),
					           checkVal : $("#temp").val(),
					           date     : $("#dateSel option:selected").val(),
							   id       : userInfo.id,
							   admflag  : userInfo.adm_flag
					        };

            navigate(form_data, "holidayList.json", successMoreList);

		}// end of moreList() ----------------------------------------

		// 총페이지 수를 가져오는 함수
		function totalPageCnt() {

			var form_data = {
					          checkVal : $("#approvalSel option:selected").val(),
					          date     : $("#dateSel option:selected").val(),
					          id       : userInfo.id,
							  admflag  : userInfo.adm_flag
					        };

			$.ajax({

		//	  	url: "http://calebslab1.cafe24.com/holidayPageCnt.json",
			  	url: "http://192.168.10.239:8080/Caleb/holidayPageCnt.json",
				type: "POST",
				async: false,
				data: form_data,
				dataType: "JSON",
				success: function(data){
					$("#pageMaxNum").val(data);

				},
				error: function(request, status, error){
					alert("code: "+request.status+"\n"+"message: "+request.responseText+"\n"+"error: "+error);
				}

			});// end of $.ajax()---------------------

		}// end of totalPageCnt() -------------------------------

		// 날짜 조회값을 append 해주는 함수
		function setDateSelct() {
			var date = new Date();
			var year = date.getFullYear();
			var html = "";

			var cnt = year - 2017 + 1;

			for(var i=0; i<cnt; i++) {

				if(i == 0) {
					html += "<option value='"+ (year - i) + "' selected='selected' >" + (year - i) + "</option>";
				}else {
					html += "<option value='"+ (year - i) + "'>" + (year - i) + "</option>";
				}

			}// end of for -----------------------

			$("#dateSel").append(html);
			$("#dateSel").selectmenu("refresh", true);

		}// end of setDateSelct() ----------------------------------------

		function successHolidayList(data) {
            $("#showList").empty();
                var html = ""

                //데이터가 없을 시
                if(data.length < 1) {
                    html += "<div class='historyline' style='text-align: center;'>";
                    html += "<span color='red'>휴가 조회내역이 없습니다.</span>";
                    html += "</div>";
                }

                for(var i=0; i<data.length; i++) {

                    var apply_seq     = data[i].apply_seq    ;
                    var start_ymd     = data[i].start_ymd    ;
                    var end_ymd       = data[i].end_ymd      ;
                    var apply_content = data[i].apply_content;

                    apply_content = apply_content.replace('\r\n\r\n', '\r\n');
                    apply_content = apply_content.replace('\r\n'    , '<br>');
                    apply_content = apply_content.replace('\\'      , ''    );

                    html += "<div class='historyline'>";
                    html +=   "<ul style='list-style: none; height: 140px;'>";
                    html +=      "<li style='float: left; width: 30%;'>";
                    html += 		"NO."+ numCnt++ +"<br>"+ data[i].apply_date;
                    html += 	 "</li>";
                    html += 	 "<li style='float: left; width: 70%;'>";
                    html += 		"<a href=javascript:viewApply('" + apply_seq + "')>신청번호 : " + apply_seq + "</a> " + data[i].name + "<br>";
                    html +=			"휴가종류 : " + data[i].h_type + "<br>";
                    html +=         start_ymd.substring(0,4) + "/" + start_ymd.substring(4,6) + "/" + start_ymd.substring(6,8) + " ~ ";
                    html +=			end_ymd.substring(0,4) + "/" + end_ymd.substring(4,6) + "/" + end_ymd.substring(6,8) + " (" + data[i].apply_count +"일)";
                    html += 		"<br>"+ apply_content +"<br>";

                    switch (data[i].approval_flag) {
                        case "신청":
                            html += 	"<font color='#bdb76b'>신청 상태입니다.</font><br>";  // #bdb76b : DarkKhaki
                            break;

                        case "검토":
                            html +=		"<font color='#6b8e23'>현재 검토중입니다.</font><br>"; // #6b8e23 : OliveDrab
                            break;

                        case "반려":
                            html +=		"<font color='red'>반려되었습니다. 반려사유를 확인하세요.</font><br>";
                            html +=		"<font color='#bdb76b'>" + data[i].approval_comment + "</font><br>"
                            break;

                        case "승인":
                            html +=		"<font color='#3cb371'>승인되었습니다.</font><br>"; // #3cb371 : MediumSeaGreen
                            break;
                    }// end of switch-----------------------------------

                    html += 	"</li>";
                    html +=   "</ul>";
                    html += "</div>";
                    html += "<div class='underline'></div>";

                }// end of for-------------------


                var pageNum    = Number($("#pageNum").val()   );
                var pageMaxNum = Number($("#pageMaxNum").val());

                // 더보기 버튼 처리
                if(pageNum < pageMaxNum ){
                    $('#btMore').show();
                }else{
                    $('#btMore').hide();
                }

                // 페이지번호 셋팅
                pageNum = Number(pageNum) + 1;
                $("#pageNum").val(pageNum);

                $("#showList").append(html);

        }// end of successHolidayList(data) -------------------------------------

        function successMoreList(data) {

            var html = "";

            for(var i=0; i<data.length; i++) {

                var apply_seq     = data[i].apply_seq    ;
                var start_ymd     = data[i].start_ymd    ;
                var end_ymd       = data[i].end_ymd      ;
                var apply_content = data[i].apply_content;

                apply_content = apply_content.replace('\r\n\r\n', '\r\n');
                apply_content = apply_content.replace('\r\n'    , '<br>');
                apply_content = apply_content.replace('\\'      , ''    );

                html += "<div class='historyline'>";
                html +=   "<ul style='list-style: none; height: 140px;'>";
                html +=      "<li style='float: left; width: 30%;'>";
                html += 		"NO."+ numCnt++ +"<br>"+ data[i].apply_date;
                html += 	 "</li>";
                html += 	 "<li style='float: left; width: 70%;'>";
                html += 		"<a href=javascript:viewApply('" + apply_seq + "')>신청번호 : " + apply_seq + "</a> " + data[i].name + "<br>";
                html +=			"휴가종류 : " + data[i].h_type + "<br>";
                html +=         start_ymd.substring(0,4) + "/" + start_ymd.substring(4,6) + "/" + start_ymd.substring(6,8) + " ~ ";
                html +=			end_ymd.substring(0,4) + "/" + end_ymd.substring(4,6) + "/" + end_ymd.substring(6,8) + " (" + data[i].apply_count +"일)";
                html += 		"<br>"+ apply_content +"<br>";

                switch (data[i].approval_flag) {

                    case "신청":
                        html += 	"<font color='#bdb76b'>신청 상태입니다.</font><br>";  // #bdb76b : DarkKhaki
                        break;

                    case "검토":
                        html +=		"<font color='#6b8e23'>현재 검토중입니다.</font><br>"; // #6b8e23 : OliveDrab
                        break;

                    case "반려":
                        html +=		"<font color='red'>반려되었습니다. 반려사유를 확인하세요.</font><br>";
                        html +=		"<font color='#bdb76b'>" + data[i].approval_comment + "</font><br>"
                        break;

                    case "승인":
                        html +=		"<font color='#3cb371'>승인되었습니다.</font><br>"; // #3cb371 : MediumSeaGreen
                        break;

                }// end of switch-----------------

                html += 	"</li>";
                html +=   "</ul>";
                html += "</div>";
                html += "<div class='underline'></div>";

            }// end of for-------------------------------------

            var pageNum    = Number($("#pageNum").val()   );
            var pageMaxNum = Number($("#pageMaxNum").val());

            // 더보기 버튼 처리
            if(pageNum < pageMaxNum) {
                $('#btMore').show();
            }else {
                $('#btMore').hide();
            }
            // 페이지번호 셋팅
            pageNum = Number(pageNum) + 1;
            $("#pageNum").val(pageNum);

            $("#showList").append(html);

        }// end of successHolidayList(data)------------------------------------------------

	</script>
    <style type="text/css">

		.underline {
			padding-top: 30px;
		    padding-bottom: 3px;
		    border-bottom: 1px solid #eee;
		    margin: 0px 0 30px 0;
		}

        .ui-btn-icon-top { padding-top : 3em;}
        .ui-bar { text-align: center; }
        .ui-bar .header-menu { float: right; }
        .ui-bar .header-back { float: left; }
        .ui-panel { width : 20em;}
        #menuPanel p { margin: 0; padding: 10px 0 5px 5px; }

	</style>

</head>
<body>
<!-- container// -->
<header data-role="header">
    <div class="ui-bar">
        <button class="header-back"><span>back</span></button>
        <h1>CalebsLab</h1>
        <a href="#menuPanel" class="btn header-menu">Menu</a>
    </div>
</header>
<div data-role="panel" id="menuPanel" data-position="right" data-display="overlay" data-theme="a">
    <h2>메뉴</h2>
    <ul data-role="listview">
        <p>내정보</p>
        <li><a href="#">마이페이지</a></li>
        <p>프로젝트</p>
        <li><a href="#">프로젝트</a></li>
        <li><a href="#">프로젝트일정 목록</a></li>
        <p>휴가</p>
        <li><a href="#">휴가신청</a></li>
        <li><a href="#">휴가신청내역</a></li>
        <li><a href="#">휴가캘린더</a></li>
        <p>게시판</p>
        <li><a href="#">FAQ</a></li>
        <p>관리</p>
        <li><a href="#">사원등록</a></li>
        <li><a href="#">사원목록</a></li>
        <li><a  onclick="movePage('main.html')">휴가현황</a></li>
    </ul>
</div>
<section class="container" data-role="content">
    <h2>휴가 조회 화면</h2>

    <div class="row" style="border: 0px solid red;">

        <div>
            <span>결제구분</span>
        </div>

        <div >
            <select id="approvalSel">
                <option value="" selected="selected">전체</option>
                <option value="신청">신청</option>
                <option value="검토">검토</option>
                <option value="반려">반려</option>
                <option value="승인">승인</option>
            </select>
        </div>

        <div id="selectDIv">
            <select  id="dateSel">

            </select>
        </div>

        <div >
            <button class="form-control btn btn-success" id="btResult" >조회</button>
        </div>

    </div>
    <div id="showList" style="padding-top: 50px;">
    </div>
    <button class="form-control btn btn-info" id="btMore" >더보기</button>

    <input type="hidden" id="pageNum" value="1">
    <input type="hidden" id="pageMaxNum">
    <input type="hidden" id="temp" >
</section>
<!-- //container -->

<!-- footer -->
<div style="overflow: hidden;" data-role="footer" data-position="fixed">
    <div data-role="navbar">
        <ul>
            <li><a href="#" data-icon="home">홈</a></li>
            <li><a href="#" data-icon="shop">프로젝트</a></li>
            <li><a href="#" data-icon="calendar">휴가신청</a></li>
            <li><a href="#" data-icon="power">로그아웃</a></li>
        </ul>
    </div>
</div>
</body>
</html>
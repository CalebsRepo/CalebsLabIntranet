<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css">
    <!--<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>-->
    <script src="../js/common.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <!--<link rel="stylesheet" href="../css/holidayDetail.css">-->
    <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:800" rel="stylesheet">

    <script language = "javascript">

    /* 휴가 정보 테이블 */
    var apply_seq_no     = ""; // 신청번호
    var id               = ""; // 아이디
    var h_type           = ""; // 휴가구분
    var h_flag           = ""; // 휴가종류
    var start_ymd        = ""; // 휴가 시작일
    var end_ymd          = ""; // 휴가 종료일
    var apply_count      = ""; // 휴가 신청일수
    var apply_content    = ""; // 휴가 사유
    var apply_date       = ""; // 휴가신청서 등록날짜
    var approval_date    = ""; // 휴가 승인일
    var approval_comment = ""; // 승인 코멘트
    var approval_flag    = ""; // 휴가 결재
    var file_name        = ""; // 휴가 신청서 파일명

    /* 사원 정보 테이블 */
    var name             = ""; // 이름
    var birth_ymd        = ""; // 생년월일
    var grade            = ""; // 직급
    var join_ymd         = ""; // 입사일
    var email            = ""; // 이메일
    var hp_num           = ""; // 핸드폰 번호
    var contact_num      = ""; // 비상번호
    var address1         = ""; // 주소
    var address2         = ""; // 상세주소
    var zip_code         = ""; // 우편번호
    var adm_flag         = ""; // 권한체크
    var resign_ymd       = ""; // 퇴사일
    var resign_reason    = ""; // 퇴사사유
    var join_year        = ""; // 입사년도
    var join_month       = ""; // 입사월
    var join_day         = ""; // 입사일
    var push_token       = ""; // push 토큰
    var hs_ymd           = ""; // 휴가갱신 시작일
    var he_ymd           = ""; // 휴가갱신 종료일

    var apply_seq_max   = ""; // 최근 신청번호
    var h_count         = ""; // 발생연차 수
    var holiday_count   = ""; // 남은연차 수

    var ajaxResult      = "";
    var ajaxResult2     = "";

    var adminToken      = ""; // 관리자 토큰
    var setToken        = ""; // 전송 토큰

    var gubun           = ""; //  gubun = 1 -->  신청 상세 페이지, gubun = 2 --> 2이면 휴가신청 페이지

    var session_id       = ""; // 세션아이디
    var sessionAdm_flag  = ""; // 세션관리자권한
    var AdminCheck       = ""; // 접속자 관리자 체크

    var pushTitle        = ""; // push 제목
    var pushBody         = ""; // push 내용

    var emailSubject     = ""; // 이메일 제목

    $(document).ready(function() {

        var userData = JSON.parse(getUserData());

        session_id          = userData.id;
        sessionAdm_flag     = userData.adm_flag;

        if(sessionStorage.getItem(temp_key) != undefined && sessionStorage.getItem(temp_key) != null && sessionStorage.getItem(temp_key) != "") {

            var value = JSON.parse(sessionStorage.getItem(temp_key));

            gubun = value.gubun;

            if(gubun == "1") { // 휴가신청 상세보기

                $("#holidayApplyBtn"    ).hide();
                $("#holidayModifyBtn"   ).show();

                var getApplySeq = value.getApplySeq;
                var getId       = value.getId;

                var holidayDetailParams = {
                    apply_seq   : getApplySeq,
                    id          : getId
                };

                navigate(holidayDetailParams, "holidayDetail.json", getHolidayDetail, "");  // 휴가신청 상세정보 가져오기
            }

            if(gubun == "2") { // 휴가신청

                $("#apply_seq_div"       ).hide();   // 신청번호 숨기기
                $("#approval_flag_div"   ).hide();   // 결재구분 숨기기
                $("#approval_comment_div").hide();   // 결재사항 숨기기
                $("#holidayApplyBtn"    ).show();   // 신청버튼 보이기
                $("#holidayModifyBtn"   ).hide();   // 수정버튼 숨기기
                $("#holidayDeleteBtn"   ).hide();   // 삭제버튼 숨기기

                var id = session_id;

                var holidayFormParams = {
                    id : id
                };

                navigate(holidayFormParams, "holidayForm.json", getHolidayForm, "");    // 휴가신청 사원정보 가져오기
            }

            navigate("", "applySeqMax.json", getRecentApplySeq, "");  // 최근 신청번호 가져오기

            /* 토큰 가져오기(관리자 또는 사원) */

            var getTokenId = "";

            if(value.getId != "silveragtl") { // 부장님 아닌 경우
                getTokenId = "silveragtl";

                var params = {
                    id : getTokenId
                };

                navigate(params , "adminToken.json", getAdminToken, "");

            }

        }

        $("#start_ymd"  ).val(getDate("-"));
        $("#end_ymd"    ).val(getDate("-"));


    });

    /* 휴가신청 사원정보 가져오기 */
    function getHolidayForm(result) {

        var date                = "";
        var year                = "";
        var toYear0101          = "";
        var holidayCountParams  = {};

        ajaxResult  = JSON.stringify(result);
        ajaxResult2 = JSON.parse(ajaxResult);

        /* 휴가신청자 정보 */
        for(var i=0; i < ajaxResult2.length; i++) {
            id          = ajaxResult2[i].id;            // 아이디
            name        = ajaxResult2[i].name;          // 이름
            grade       = ajaxResult2[i].grade;         // 직급
            email       = ajaxResult2[i].email;         // 이메일
            hp_num      = ajaxResult2[i].hp_num;        // 전화번호
            contact_num = ajaxResult2[i].contact_num;   // 비상연락처
            join_ymd    = ajaxResult2[i].join_ymd;      // 입사일
            resign_ymd  = ajaxResult2[i].resign_ymd;    // 퇴사일
            join_year   = ajaxResult2[i].join_year;     // 입사년도
            join_mon    = ajaxResult2[i].join_mon;      // 입사월
            join_day    = ajaxResult2[i].join_day;      // 입사일
            push_token  = ajaxResult2[i].push_token     // push 토큰
            hs_ymd      = ajaxResult2[i].hs_ymd;        // 휴가갱신 시작일
            he_ymd      = ajaxResult2[i].he_ymd;        // 휴가갱신 종료일
        }

         h_count = GetCntMyHoliday(join_year, join_mon, join_day); // 발생 연차 수

         date        = new Date();
         year        = date.getFullYear();   // 년
         toYear0101  = year + "0101";

         holidayCountParams = {
            id          : id,
            toYear0101  : toYear0101
         };

         navigate(holidayCountParams, "holidayCount.json", getHolidayCount, "");  // 사용연차 수 가져오기

         // 휴가갱신종료일이 금일보다 작거나 같으면 휴가연차 새로 갱신
         // 20180114 + 10000,   20190113 + 10000
         if(getDate() >= he_ymd) {
            hs_ymd = Number(hs_ymd) + 10000;
            he_ymd = Number(he_ymd) + 10000;
         }

        /* 연차정보 출력 */
        //$("#holiday_detail_count").append("연차발생기간 : " + hs_ymd + " ~ " + he_ymd + "<br>발생연차 수 : " + h_count);
        $("#holiday_period"     ).append(dateFormat(hs_ymd) + " ~ " + dateFormat(he_ymd) ).css("color", "#999");
        $("#holiday_total_count").append(h_count + " 일"                                 );
        $("#name_grade").html("[성명 : " + name + "] " + "[직급 : " + grade + "]");
    }

    /* 휴가신청 상세정보 가져오기 */
    function getHolidayDetail(result) {

        ajaxResult  =JSON.stringify(result);
        ajaxResult2 =JSON.parse(ajaxResult);

        for(var i=0; i < ajaxResult2.length; i++){

            /* 휴가신청자 휴가 정보*/
            apply_seq_no     = ajaxResult2[0].apply_seq;        // 신청번호
            id               = ajaxResult2[0].id;               // 아이디
            h_type           = ajaxResult2[0].h_type;           // 휴가구분
            h_flag           = ajaxResult2[0].h_flag;           // 휴가종류
            start_ymd        = ajaxResult2[0].start_ymd;        // 휴가시작일
            end_ymd          = ajaxResult2[0].end_ymd;          // 휴가종료일
            apply_count      = ajaxResult2[0].apply_count;      // 휴가신청일수
            apply_content    = ajaxResult2[0].apply_content;    // 휴가사유
            apply_date       = ajaxResult2[0].apply_date;       // 휴가신청서 등록날짜
            approval_date    = ajaxResult2[0].approval_date;    // 휴가승인일
            approval_comment = ajaxResult2[0].approval_comment; // 승인 코멘트
            approval_flag    = ajaxResult2[0].approval_flag;    // 휴가결재
            file_name        = ajaxResult2[0].file_name;        // 휴가신청서 파일명

            /* 휴가신청자 정보 */
            name             = ajaxResult2[0].name;             // 이름
            birth_ymd        = ajaxResult2[0].birth_ymd;        // 생년월일
            grade            = ajaxResult2[0].grade;            // 직급
            join_ymd         = ajaxResult2[0].join_ymd;         // 입사일
            email            = ajaxResult2[0].email;            // 이메일
            hp_num           = ajaxResult2[0].hp_num;           // 핸드폰 번호
            contact_num      = ajaxResult2[0].contact_num;      // 비상번호
            address1         = ajaxResult2[0].address1;         // 주소
            address2         = ajaxResult2[0].address2;         // 상세주소
            zip_code         = ajaxResult2[0].zip_code;         // 우편번호
            adm_flag         = ajaxResult2[0].adm_flag;         // 권한체크
            resign_ymd       = ajaxResult2[0].resign_ymd;       // 퇴사일
            resign_reason    = ajaxResult2[0].resign_reason;    // 퇴사사유
            join_year        = ajaxResult2[0].join_year;        // 입사년도
            join_month       = ajaxResult2[0].join_month;       // 입사월
            join_day         = ajaxResult2[0].join_day;         // 입사일
            push_token       = ajaxResult2[0].push_token;       // push 토큰
            hs_ymd           = ajaxResult2[0].hs_ymd;           // 휴가갱신 시작일
            he_ymd           = ajaxResult2[0].he_ymd;           // 휴가갱신 종료일

        }

        /* 신청번호 출력 */
        $("#apply_seq"          ).html(apply_seq_no + " (" + apply_date + ")"); // 신청번호 출력

        /* 휴가구분 선택 */
        $("#h_type"             ).val(h_type).prop("selected", true);
        //$("#h_type"           ).selectmenu("refresh", true);

        /* 휴가종류 선택 */
        $("#h_flag"             ).val(h_flag).prop("selected", true);
        //$("#h_flag"           ).selectmenu("refresh", true);

        /* 휴가 시작일, 휴가 종료일 세팅*/
        $("#start_ymd"          ).val(start_ymd.substring(0,4)  + "-" + start_ymd.substring(4,6)    + "-" + start_ymd.substring(6,8));
        $("#end_ymd"            ).val(end_ymd.substring(0,4)    + "-" + end_ymd.substring(4,6)      + "-" + end_ymd.substring(6,8)  );

        /* 휴가일수 선택 */
        $("#apply_count"        ).val(apply_count).prop("selected", true);
        //$("#apply_count"      ).selectmenu("refresh", true);

        /* 휴가사유 출력 */
        $("#apply_content"      ).html(apply_content);

        /* 신청처리 결과 선택 */
        $("#approval_flag"      ).val(approval_flag).prop("selected", true);
        //$("#approval_flag"    ).selectmenu("refresh", true);
        //$("approval_flag_div" ).html("(" + approval_date + ")");

        /* 결재사항 출력 */
        $("#approval_comment"   ).html(approval_comment);

        /* 관리자가 아닌 경우 */
        if(sessionAdm_flag != "G" && sessionAdm_flag != "A") {
            $("#approval_flag"      ).attr("disabled", "disabled"); // 신청처리 결과 disabled
            $("#approval_comment"   ).attr("disabled", "disabled"); // 결재사항 disabled

            if(session_id != id) { // 로그인아이디와 휴가신청한 아이디가 다른 경우
                $("#modifyBtn").attr("disabled", "disabled"); // 수정버튼 disabled
            }

            if(approval_flag != "신청") { // 신청처리결과가 '신청'이 아닌경우
                $("#holidayModifyBtn").hide(); // 수정버튼 숨기기
                $("#memberHolidayCancelBtn").show(); // 취소버튼 보여주기
                $("#holidayCancelBtn").hide(); // 취소버튼 숨기기
            }
            if(approval_flag == "신청") { // 신청 처리결과가 '신청'인 경우
                $("#approval_comment_div").hide(); // 결재사항 숨기기
            }

        }/*else if(sessionAdm_flag == "G" || sessionAdm_flag == "A") {
            if(approval_flag == "신청") {
                $("#modifyBtn"   ).html("결재");
            }
        }
        */

        /* 승인신청 결과가 승인 또는 반려 또는 검토 이면서 로그인한 사원의 권한이 관리자가 아닌경우 */
        if((approval_flag == "승인" || approval_flag == "반려" || approval_flag == "검토")  && (sessionAdm_flag != "G" && sessionAdm_flag != "A")) {
            $("#holidayDeleteBtn"   ).hide();   // 삭제버튼 숨기기
            $("#holidayApplyBtn"    ).hide();   // 수정버튼 숨기기
            $("#holidayDeleteBtn"   ).attr("disabled", "disabled"); // 삭제버튼 disabled
            $("#applyBtn"           ).attr("disabled", "disabled"); // 신청버튼 disabled
            $("#h_type"             ).attr("disabled", "disabled"); // 휴가구분 disabled
            $("#h_flag"             ).attr("disabled", "disabled"); // 휴가종류 disabled
            $("start_ymd"           ).attr("readonly", true);   // 수정 필요
            $("end_ymd"             ).attr("readonly", true);   // 수정 필요
            $("#apply_count"        ).attr("disabled", "disabled"); // 휴가신청일수 disabled
            $("#apply_content"      ).attr("disabled", "disabled"); // 휴가사유 disabled
        }

        h_count = GetCntMyHoliday(join_year, join_month, join_day); // 발생 연차 수

        var date        = new Date();
        var year        = date.getFullYear();   // 년
        var toYear0101  = year + "0101";

        var holidayCountParams = {
                id          : id,
                toYear0101  : toYear0101
        };

        navigate(holidayCountParams, "holidayCount.json", getHolidayCount, "");  // 사용 연차 수 가져오기

        // 휴가갱신종료일이 금일보다 작거나 같으면 휴가연차새로 갱신
        // 20180114 + 10000,   20190113 + 10000
        if(getDate() >= he_ymd) {
            hs_ymd = Number(hs_ymd) + 10000;
            he_ymd = Number(he_ymd) + 10000;
        }

        /* 연차정보 출력 */
        //$("#holiday_detail_count").append("연차발생기간 : " + hs_ymd + " ~ " + he_ymd + "<br>발생연차 수 : " + h_count);

        $("#holiday_period"     ).append(dateFormat(hs_ymd) + " ~ " + dateFormat(he_ymd) ).css("color", "#999");
        $("#holiday_total_count").append(h_count + " 일"                                 );
        $("#name_grade").html("[성명 : " + name + "] " + "[직급 : " + grade + "]");

    }

    /* 최근 신청번호 가져오기 */
    function getRecentApplySeq(result) {

        ajaxResult=JSON.stringify(result);
        ajaxResult2=JSON.parse(ajaxResult);

        for(var i=0; i < ajaxResult2.length; i++){
            apply_seq_max = ajaxResult2[i].apply_seq_max;
        }
    }


    /* 휴가신청서 등록 */
    function holidayApply(flag) {

        var h_type_val              = $("#h_type"           ).val();    // 휴가 구분
        var h_flag_val              = $("#h_flag"           ).val();    // 휴가 종류
        var start_ymd_val           = $("#start_ymd"        ).val();    // 휴가 시작일
        var end_ymd_val             = $("#end_ymd"          ).val();    // 휴가 종료일
        var apply_count_val         = $("#apply_count"      ).val();    // 신청일수
        var apply_content_val       = $("#apply_content"    ).val();    // 휴가 사유
        var approval_flag_val       = $("#approval_flag"    ).val();    // 결재구분
        var approval_comment_val    = $("#approval_comment" ).val();    // 결재사항

        var ConfirmMsg      = ""; // 신청 확인용 메세지

        start_ymd_val   = start_ymd_val.replace(/-/gi, "");
        end_ymd_val     = end_ymd_val.replace(/-/gi, "");

        if(flag == "apply") { // 결재구분이 신청인 경우
            ConfirmMsg = "신청 하시겠습니까?";
            if(h_type_val == "") {
                alert("휴가 구분을 선택해주세요.");
                return false;
            }else if(h_flag_val == "") {
                alert("휴가 종류를 선택해주세요.");
                return false;
            }else if(start_ymd_val == "" || end_ymd_val == "") {
                alert("휴가 기간을 선택해주세요.");
                return false;
            }else if(apply_count_val == "") {
                alert("휴가신청일수를 선택해주세요.");
                return false;
            }else if(apply_content_val.replace("\n", "").length < 14) {
                alert("사유, 장소 포함하여 4글자 이상 작성하여 주세요.");
                return false;
            }if(start_ymd_val > end_ymd_val) {
                alert("휴가시작일이 종료일보다 클 수는 없습니다.");
                return;
            }/*else if(apply_count_val != (end_ymd_val - start_ymd_val)+1) {
                alert("휴가신청일수가 올바르지 않습니다. 다시 선택해주세요.");
                return false;
            }*/
        }else if(flag == "modify") {    // 결재구분이 수정인 경우
            ConfirmMsg = $("#modifyBtn").html() +" 하시겠습니까?";
            if(sessionAdm_flag == "G" || sessionAdm_flag == "A") {
                if(approval_flag_val == ""){
                    alert("결재구분을 선택해주세요.");
                    return false;
                }
            }
        }

        if(window.confirm(ConfirmMsg))
        {
            if(flag == "apply") { // 결재구분이 신청인 경우

                if(session_id != "silveragtl") { // 이부분 테스트용으로 poowoo90으로 사용
                    setToken = adminToken;
                }else {
                    setToken = "";
                }

                apply_seq_no = getDate() + "01"; // 신청번호 (신청하는날짜+01) ex) 2018010501


                if(apply_seq_no > apply_seq_max ) {  // 가장 최근 신청 번호 보다 오늘신청한 신청번호가 크면

                    apply_seq_no = apply_seq_no;

                }else {

                    var sub_seq = Number(apply_seq_max.substr(8,2)) + 1;   // 신청번호 마지막 두자리에 +1  ex)2018010501 ----> 01+1 = 2

                    if(sub_seq < 10) {
                        sub_seq = "0"+ sub_seq;   // 10보다 작을경우 앞에 0을 다시 붙여준다.
                    }

                    apply_seq_no = apply_seq_max.substring(0,8) + sub_seq; // 신청번호 재정의
                }

                emailSubject = "휴가신청 : " + "(" + start_ymd_val + " ~ " + end_ymd_val + ", " + apply_count_val + "일" + ")" + h_type + " 휴가신청 합니다.";

                pushTitle = name + " " + grade + " 휴가 신청 하였습니다.";

                pushBody = apply_content_val + "\n휴가 기간 : " + "(" + start_ymd_val + " ~ " + end_ymd_val + ", " + apply_count_val + "일" + ")";

            }else if(flag == "modify") { // 결재구분이 수정인 경우

                if(session_id != "silveragtl") { // 이부분 테스트용으로 poowoo90으로 사용
                                         // 부장님이 아닌 경우
                    setToken = adminToken; // 부장님 토큰 셋팅

                    emailSubject    = name + " " + grade + " 휴가신청서 수정하였습니다.";
                    pushTitle       = name + " " + grade + " 휴가신청서 수정하였습니다.";
                    pushBody        = apply_content_val + "\n휴가 기간 : " + "(" + start_ymd_val + " ~ " + end_ymd_val + ", " + apply_count_val + "일" + ")";

                    //emailSubject    = "신청번호 : " + apply_seq_no + " 휴가신청서 수정하였습니다.";
                    //pushTitle       = "신청번호 : " + apply_seq_no + " 휴가신청서 수정하였습니다.";

                }else { // 부장님인 경우

                    if(session_id == id) {
                         setToken = "";
                    }else {
                        setToken = push_token;
                    }

                    if($("#modifyBtn").html() == "결재") {
                        emailSubject    = name + " " + grade + " 휴가신청서 결재되었습니다.";
                        pushTitle       = name + " " + grade + " 휴가신청서 결재되었습니다.";
                        pushBody        = "휴가 신청 번호 : " + apply_seq_no + "\n결재 내용 : " +  approval_flag_val + " 처리 되었습니다.";
                        //emailSubject    = name + " " + grade + " 신청번호 : " + apply_seq_no + " 휴가신청서 결재되었습니다.";
                        //pushTitle       = name + " " + grade + " 휴가신청서 결재되었습니다.";
                    }else {
                        //emailSubject = name + " " + grade + " 휴가신청서 수정되었습니다.";
                        //pushTitle    = name + " " + grade + " 휴가신청서 수정되었습니다.";
                        emailSubject = "휴가 신청 번호 : " + apply_seq_no + " 수정되었습니다.";
                        pushTitle    = "휴가 신청 번호 : " + apply_seq_no + " 수정되었습니다.";
                        pushBody     = apply_content_val + "\n휴가 기간 : " + "(" + start_ymd_val + " ~ " + end_ymd_val + ", " + apply_count_val + "일" + ")";
                    }
                }
            }

            apply_content_val = apply_content_val.replace(/(?:\r\n|\r|\n)/g, "<br />"); // textarea 줄바꿈 변환

            var params = {
                apply_seq_no     : apply_seq_no,
                approval_comment : approval_comment_val,
                id               : id,
                h_type           : h_type_val,
                h_flag           : h_flag_val,
                start_ymd        : start_ymd_val,
                end_ymd          : end_ymd_val,
                apply_count      : apply_count_val,
                apply_content    : apply_content_val,
                approval_flag    : approval_flag_val
            };

            if(flag == "apply") { // 결재구분이 신청인 경우
                navigate(params, "holidayApply.json", holidaySuccess, "");  // 휴가 신청 등록
            }else if(flag == "modify") { // 결재구분이 수정인 경우
                if(sessionAdm_flag == "G" || sessionAdm_flag == "A") { // 관리자인 경우
                    navigate(params, "holidayModifyAdmin.json", holidaySuccess, "");  // 휴가 신청서 수정 (관리자)
                }else { // 관리자가 아닌 경우
                    navigate(params, "holidayModifyUser.json", holidaySuccess, ""); // 휴가 신청서 수정(사원)
                }
            }

        }

    }

    /* 휴가신청/결재/수정 완료 */
    function holidaySuccess() {

        /*
        push 여러사람에게 보낼 때는 배열로
        var tokenArray = new Array();
        */

        //var imgURL = "http://calebslab1.cdn3.cafe24.com/imployeeInfo/sign/20190122_142122.jpg";

        /* 디바이스 내에서 전송 시
        var sendPushMessage = {
            title   : pushTitle,    // push 제목
            body    : pushBody,     // push 내용
            token   : setToken,     // push 토큰
            type    : "holiday",     // push 전송처리 구분
            //picture : imgURL
            //token   : tokenArray
        };
        */

        /* 서버에서 전송 시 */
        var sendPushMessage = {
            flag    : "single",
            title   : pushTitle,    // push 제목
            body    : pushBody,     // push 내용
            token   : setToken,     // push 토큰
            type    : "holiday"     // push 전송처리 구분
            //picture : imgURL
            //token   : tokenArray
        };

        pushNavigate(sendPushMessage, "sendFCM.json");  // 서버에서 push 전송

        //sendFirebase(sendPushMessage, "single", "", ""); // 디바이스 내에서 push 전송


        var sendMail = new Array();

        sendMail[0] = "poowoo90@gmail.com";
        sendMail[1] = "skarldhks123@naver.com";

        Email.send({
            SecureToken : "d4c3cfe4-e2e2-4925-9a94-1f21d2568bc2",   // 보내는 사람의 메일 토큰
            To : sendMail,                                          // 받는 사람
            From : "contact@calebslab.com",                         // 보내는 사람
            Subject : emailSubject,                                 // 메일 제목
            Body : $("#apply_content").val().replace("\n", "<br>"), // 메일 내용
        }).then(
            //message => alert(message)
            setTimeout(function() { movePage("holidayList.html") }, 1200)

        );


    }

    /* 휴기신청서 삭제 */
    function holidayDelete() {
        var params = {
            apply_seq_no : apply_seq_no
        };
        navigate(params, "holidayDelete.json", "", ""); // 휴가신청서 삭제
    }

    /* 남은 연차수 가져오기 */
    function getHolidayCount(result) {

        ajaxResult=JSON.stringify(result);
        ajaxResult2=JSON.parse(ajaxResult);


        for(var i=0; i < ajaxResult2.length; i++){
            holiday_count = ajaxResult2[0].cnt;
        }

        $("#used_holiday_count"  ).append(holiday_count + " 일");
        $("#used_holiday_count"  ).css("color", "#2478FF");

        holiday_count = h_count - holiday_count;

       //$("#holiday_detail_count").append("<br>남은연차 수 : " + holiday_count);
       $("#available_holiday"   ).append(holiday_count  + " 일");

       if(holiday_count >= 0) {
            $("#available_holiday").css("color", "#0BC904");
       }else {
            $("#available_holiday").css("color", "#FF1212");
       }
    }


    /* 발생 연차수 구하기 */
    function GetCntMyHoliday(join_year_val, join_mon_val, join_day_val) {

        console.log("join_year_val : " + join_year_val + "      join_mon_val : " + join_mon_val + "           join_day_val : " + join_day_val);

        var h_count = 15;   //  기본휴가일수
        var wd_80   = 292;  //  입사 후 1년 80% 근무일수

        if(join_year_val == 3)
        {
            h_count = h_count + 1; // 입사후 3년 근무 시 15 + 1 일 휴가
        }else if(join_year_val > 3)
        {
            h_count = h_count + 1 + Number((join_year_val-3)/2); // 입사 3년 후 2년마다 +1:  15+1 + (2년*1)일 휴가 max : 25
            if(h_count > 25) h_count = 25;
        }else if(join_year_val == 1 || join_year_val == 2) {
            h_count = 15; // 입사 3년 이전
        }else
        {
            h_count = join_mon_val * 1; // 근속년수 80% 미만인 사람은 1개월 개근시 1일의 휴가

            /*
            if(join_day_val < wd_80)
            {
               h_count = join_mon_val * 1; // 근속년수 80% 미만인 사람은 1개월 개근시 1일의 휴가
            }else if(join_day_val >= wd_80 && join_year_val == 1)
            {
               h_count = 15 * ( join_day_val / 365 ); // 근속년수 80% 이상인 사람은 15일의 연차휴가 발생
               h_count = round(h_count);
            }
            */
        }
        console.log("h_count : " + h_count);
        return h_count;
    }


    /* 오늘 날짜 구하기 */
    function getDate(hyphen) {
        var date    = new Date();
        var year    = date.getFullYear();   // 년
        var month   = date.getMonth() + 1;  // 월
        var day     = date.getDate();       // 일

        if (month < 10) {   //  1~9월까지 앞에 '0' 삽입
            month = "0" + month;
        }

        if (day < 10) {     // 1~9일까지 앞에 '0' 삽입
            day = "0" + day;
        }

        if(hyphen != "" && hyphen != null) {
            return year + hyphen + month + hyphen + day
        }else {
            return year + month + day;
        }
    }

    /* 날짜 형식 포멧 */
    function dateFormat(date) {

        year    = date.substr(0, 4);
        month   = date.substr(4, 2);
        day     = date.substr(6, 2);

        return year + "-" + month + "-" + day;

    }

    /* 결재구분 selectbox 이벤트 */
    function approvalChange() {
        if(sessionAdm_flag == "G" || sessionAdm_flag == "A") {
            /*
            if(approval_flag == "신청") {
                if($("#approval_flag").val() == "신청") {
                    $("#modifyBtn"   ).html("수정");
                }else {
                    $("#modifyBtn"   ).html("결재");
                }
            }
            */
            if(approval_flag != $("#approval_flag").val()) {
                $("#modifyBtn").html("결재");
            }else {
                $("#modifyBtn").html("수정");
            }

        }
    }

    /* 관리자 토큰 가져오기 */
    function getAdminToken(result) {
        ajaxResult=JSON.stringify(result);
        ajaxResult2=JSON.parse(ajaxResult);

        for(var i=0; i < ajaxResult2.length; i++){
            adminToken     = ajaxResult2[0].adminToken;        // 관리자 토큰
        }
    }

    /* 취소 버튼 선택 */
    function holidayCancel() {
        history.back(); // 페이지 뒤로 이동
    }

    /* ajax 통신 실패 */
    function errorFncMultiSndSample(result) {
        console.log("errorFncMultiSndSample >>>>>>" + JSON.stringify(result));
    }



   </script>

    <style>

        #apply_seq_div, #h_type_div, #h_flag_div, #holiday_period_div, #apply_count_div, #holiday_detail_info_div, #apply_content_div, #approval_flag_div, #approval_comment_div {
            margin-bottom : 20px;
        }


        label {
            font-family: 'Nanum Gothic', sans-serif;
            border-bottom: solid 1px gray;
        }

        table {
            width:100%; border:0; border-spacing:0; border-collapse:collapse; table-layout:fixed;}
        }

        .btn-area-1 .grid-pt{width:100%; display:flex;}
        .btn-area-1 .grid-pt .grid-cd-1{width: 48%; display:inline-flex; margin-right:0.1em;}
        .btn-area-1 .grid-pt .grid-cd-2{width: 48%; display:inline-flex; margin-left:0.1em;}
        .btn-area-1 .grid-pt .grid-cd-2 a.ui-btn-b{border: #3388cc;}
        .btn-area-1 .grid-pt a{width:100%;}

        select {
            width : 100%;
            height : 41px;
            font-size : 15px;
            color : #999;
            border : 1px solid #ddd;
            background : white;
        }
        select :: -ms-expand{opacity : 0;}

        #start_ymd, #end_ymd {
            color : #999;
            font-size : 15px;
        }

        #apply_content{
            color : #999;
        }

        #holiday_detail_count_table {
            font-size : 15px;
        }



    </style>
</head>
<body>
<div id="holidayForm" data-role="page">

    <div id="applicationForm_div" data-role="content">
        <!--   <div id="title_div" data-role="">
               <h1 id="title">휴가 신청 정보</h1>
               <h4 id = "name_grade"></h4>
           </div>
        -->
        <div id="apply_seq_div">
            <label>신청번호</label>
            <h4 id ="apply_seq"></h4>
        </div>

        <div id="h_type_div">
            <label>휴가 구분</label>
            <select id = "h_type" data-role="none"  data-theme="b">
                <option value="연차" selected>연차</option>
                <option value="특별">특별</option>
            </select>
        </div>

        <div id="h_flag_div">
            <label>휴가 종류</label>
            <select id = "h_flag" data-role="none" >
                <option value="refresh" selected>refresh</option>
                <option value="가족">가족</option>
                <option value="경조사">경조사</option>
                <option value="공항">공항</option>
                <option value="기타">기타</option>
                <option value="매매">매매</option>
                <option value="병원">병원</option>
                <option value="여행">여행</option>
                <option value="오후">오후</option>
                <option value="육아">육아</option>
                <option value="일반">일반</option>
                <option value="자녀">자녀</option>
                <option value="출산">출산</option>
                <option value="플젝">플젝</option>
            </select>
        </div>

        <div id="holiday_period_div">
            <label>휴가기간</label>
            <table>
                <tr>
                    <td style="width:48%;"><input id="start_ymd" type="date" value=""></td>
                    <td> ~ </td>
                    <td style="width:48%;"><input id="end_ymd" type="date" value=""></td>
                </tr>
                <!--
                <tr>
                    <td style="width:25%">휴가시작일</td>
                    <td><input id="start_ymd" type="date" value=""></td>
                </tr>
                <tr>
                    <td style="width:25%">휴가종료일</td>
                    <td><input id="end_ymd" type="date" value=""></td>
                </tr>
                -->
            </table>
        </div>

        <div id="apply_count_div">
            <label>휴가신청일수</label>
            <select id = "apply_count" data-role="none">
                <option value="0.5">0.5</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
            </select>
        </div>

        <div id="holiday_detail_info_div">
            <label>연차정보</label>
            <!--<h5 id="holiday_detail_count"></h5>-->
            <table id="holiday_detail_count_table">
                <tr>
                    <td style="width:40%; color:#999;">연차발생기간</td>
                    <td id="holiday_period"></td>
                </tr>
                <tr>
                    <td style="width:40%; color:#999;">총 연차 일수</td>
                    <td id="holiday_total_count"></td>
                </tr>
                <tr>
                    <td style="width:40%; color:#999;">사용한 연차 일수</td>
                    <td id="used_holiday_count"></td>
                </tr>
                <tr>
                    <td style="width:40%; color:#999;">남은 연차 일수</td>
                    <td id="available_holiday"></td>
                </tr>
            </table>
            <!--<textarea name="holiday_detail_count" id="holiday_detail_count" rows="8" cols="70" style="color:#373D45; background-color:#FFFF9F; overflow-x:hidden; overflow-y:auto;" ></textarea>-->
            <!--<input type ="text" id="holiday_detail_count" disabled>-->
        </div>

        <div id ="apply_content_div">
            <label>휴가사유</label>
            <textarea name="apply_content" id="apply_content" class="textarea01" rows="8" cols="70" style="color:#999; background-color:#FFFF6C; overflow-x:hidden; overflow-y:auto; font-size:15px;">사유 : &#10;장소 : </textarea>
        </div>

        <div id="approval_flag_div">
            <label>신청처리 결과</label>
            <select id = "approval_flag" onchange="approvalChange()" data-role="none">
                <option value="">결재처리</option>
                <option value="검토">검토중</option>
                <option value="승인">승인</option>
                <option value="반려">반려</option>
                <option value="신청">신청</option>
            </select>
        </div>

        <div id="approval_comment_div">
            <label>결재사항</label>
            <textarea name="approval_comment" id="approval_comment" class="textarea01" rows="8" cols="70" style="color:#373D45; background-color:#FFFFB3; overflow-x:hidden; overflow-y:auto;"></textarea>
        </div>

        <div class="btn-area-1">
            <div class="grid-pt">
                <div class="grid-cd-1"  id="holidayCancelBtn"   ><button onclick="holidayCancel();"                                                                 >취소</button></div>
                <div class="grid-cd-2"  id="holidayApplyBtn"    ><button class="ui-btn ui-corner-all ui-btn-b" id="applyBtn"    onclick="holidayApply('apply');"    >신청</button></div>
                <div class="grid-cd-2"  id="holidayModifyBtn"   ><button class="ui-btn ui-corner-all ui-btn-b" id="modifyBtn"   onclick="holidayApply('modify');"   >수정</button></div>
            </div>
        </div>
        <div class="btn-area-2">
            <div class="gird-pt">
                <button class="ui-btn ui-corner-all ui-btn-b" id="holidayDeleteBtn"         onclick="holidayDelete();" style="background-color:#FF3636;">삭제</button>
                <button                                       id="memberHolidayCancelBtn"   onclick="holidayCancel();" style="display:none;">취소</button>
            </div>
        </div>

    </div>

</div>
</body>
</html>